<!--[if lt IE 9]>
<!-- For compatibility with older IEs -->
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
<script src="/js/excanvas.min.js"></script>
<![endif]-->

%link{ :rel => 'stylesheet', :href => '/css/style.css' }
%link{ :rel => 'stylesheet', :href => '/fonts/Otari-Regular-Web/stylesheet.css' }

%h1 Math

%form{ :id => 'record_form', :method => 'POST', :action => '/records' }
	%p
		%input{ :type => 'text', :name => 'item_name', :id => 'item_name', :placeholder => 'Item' }
	%p
		%input{ :type => 'text', :name => 'amount', :id => 'amount', :placeholder => 'Amount' }
	%p
		%input{ :type => 'submit', :value => 'Save' }

%ul#records.active

%script{ :type => 'text/javascript', :src => '/js/zepto.min.js' }
%script{ :type => 'text/javascript', :src => '/js/chartwell.min.js' }
%script{ :type => 'text/javascript', :src => '/js/chartwell_lines.min.js' }
%script{ :type => 'text/javascript', :src => '/js/keymaster.min.js' }

:javascript
	var items = [];
	var records = {};

	$(document).ready(function ($) {
		key.filter = function (event) {
		  var tagName = (event.target || event.srcElement).tagName;
		  return !(tagName == 'SELECT' || tagName == 'TEXTAREA');
		}

		//switch to record form with ` key
	  key('`', function(e){
	    form_active();
	  })

	  //switch to records list with escape
	  key('esc', function(){
	    list_active();
	  })

	  form_active = function () {
	  	if (!$('#record_form').hasClass('active')) {
	      $('#records').removeClass('active');
	      $('#record_form').addClass('active')
	    }
	  }

	  list_active = function () {
	  	if (!$('#records').hasClass('active')) {
	      $('#record_form').removeClass('active');
	      $('#records').addClass('active');
	    }
	  }

	  //get items
	  $.getJSON(
	    '/api/1/users/#{@user.id.to_s}/items?accesskey=#{@user.accesskey.token.to_s}',
	    function (e) {
	      $(e).each(function (i, item) {
	        items[item.id] = item.name
	      })
	    }
	  )

	  //get records
	  $.getJSON(
	    '/api/1/users/#{@user.id.to_s}/records?accesskey=#{@user.accesskey.token.to_s}',
	    function (e) {
	      $(e).each(function (i, recs) {
	        records[recs[0].item] = recs
	      })

	      displayRecords();
	    }
	  )

	  displayRecords = function () {
	    for (var i in records) {
	      var recs = records[i]

	      var total = 0,
	          entries = recs.length,
	          item = recs[0].item,
	          numbers = [];


	      $(recs).each(function (b, record) {
	        amount = parseInt(record.amount, 10)

	        //we shouldn't need to check this if we're doing integer validation on entry
	        if (!isNaN(amount)) {
	          total += parseInt(record.amount, 10)
	          numbers.push(record.amount)
	        }
	      })

	      var data = numbers.slice(numbers.length - 14, numbers.length)
	      console.log(data)
	      var max = 0;

	      for (var i in data) {
	        var amount = data[i];

	        if (amount > max) {
	          max = amount;
	        }

	        if ((parseFloat(amount) == parseInt(amount)) && !isNaN(amount)) {
	          numbers += "<span>" + amount + "</span>"
	        }
	      }

	      $('#records').append('<li id="' + item + '" class="block"><h2>' + items[item] + '</h2> ' + total + ' (' + entries + ' records)<div style="font-size: 62px"><span class="graph chartwell lines"></span></div>')

	      var graph = $('#' + item).find('span.graph');
	      $(graph).html(numbers.substr(0,numbers.length - 1))
	    }

	    FFChartwell();
	  }

	  $('#record_form').bind('submit', function (e) {
	    e.preventDefault();

	    $.ajax({
	      type: 'post',
	      url: '/api/1/users/#{@user.id.to_s}/records',
	      dataType: 'json',
	      data: {
	        accesskey: '#{@user.accesskey.token.to_s}',
	        item_name: $('#record_form #item_name').val(),
	        amount: $('#record_form #amount').val()
	      },
	      success: function (e) {
	        records[e.item].push(e)

	        $('#records').empty()
	        displayRecords()
	        list_active();
	      }
	    })
	  })
	})
